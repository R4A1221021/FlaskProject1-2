{% extends "layout.html" %}

{% block title %}マップ{% endblock %}

{% block content %}
<style>
    /* Google Mapsのコンテナは明示的な高さが必要です */
    #map {
        height: 70vh; /* 画面の高さの70% */
        width: 100%;
        background-color: #e5e7eb; /* 未ロード時の背景色 */
    }
</style>

<div class="flex flex-col h-full">
    <h2 class="text-2xl font-bold mb-4 text-gray-800">マップ (Google Maps)</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                {% if category == 'danger' %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4 w-full" role="alert">
                    {{ message }}
                </div>
                {% endif %}
            {% endfor %}
        {% endif %}
    {% endwith %}

    {% if api_key %}
        <div id="map" class="rounded-xl shadow-lg z-0"></div>
    {% else %}
        <div class="bg-gray-300 w-full h-[70vh] rounded-xl shadow-lg z-0 flex items-center justify-center">
            <p class="text-gray-600 font-medium">地図をロードできませんでした。(APIキー未設定)</p>
        </div>
    {% endif %}

    <div class="bg-white p-4 rounded-xl shadow-lg mt-4">
        <button class="w-full bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 transition-colors font-semibold opacity-50 cursor-not-allowed" disabled>
            位置情報共有 (未実装)
        </button>
    </div>
</div>
{% endblock %}

{% block scripts %}
{% if api_key %}
<script>
    // この関数はGoogle Maps APIによってコールバックされます
    function initMap() {
        // 1. サンプル座標 (例: 東京駅)
        const tokyoStation = { lat: 35.681236, lng: 139.767125 };

        // 2. 地図を作成し、'map' IDのdivにアタッチ
        const map = new google.maps.Map(document.getElementById("map"), {
            zoom: 14, // ズームレベル
            center: tokyoStation, // 中心座標
        });

        // 3. サンプルマーカーを立てる
        new google.maps.Marker({
            position: tokyoStation,
            map: map,
            title: "東京駅 (サンプル)",
        });
    }
</script>

<script async
    src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap">
</script>
{% endif %}
{% endblock %}